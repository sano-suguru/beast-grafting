# Beast Binding Arena - 仕様書

## 設計決定

### GitHub Modelsで無料運用

GitHub Modelsの無料枠でGPT-4oを使う。レート制限があるため、1日1回の定期興行 + 登録時の初陣に絞る。

本格運用時はAzure OpenAIへ移行可能。エンドポイントを差し替えるだけ。

### Issue起点のワークフロー

非エンジニアも参加できるよう、Issue Template（フォーム）で登録する。GitHub Actionsが自動でPR生成。エンジニアは直接PRも可。

フォーム入力 → YAML生成を自動化することで、YAMLやGitの知識を不要にする。

### 最小入力でAI自動生成

ライトユーザーの参加障壁を下げるため、最小限の入力で残りをAIが自動生成する。

```yaml
# 必須（ユーザー入力）
name: グリム
species: 鬣犬

# 任意（空ならAIが生成、書けば優先）
origin: 
lore: 
traits: 
skills: 
```

こだわる人は全部書ける。ライトユーザーは名前と種族だけで参加できる。

### 数値管理しない

ステータスは数値ではなく自由記述（traits）。創造性を優先する。バランスより物語。

AIが traits、skills、lore を材料に戦闘を生成する。数値による勝敗計算は行わない。

### 勝敗・死亡はAIが決める

勝敗記録（wins/losses）は管理するが、戦闘の展開と結果はAIが物語として生成する。

死亡もAIが判断する。戦闘中の致命傷、または敗北後のイベント（観客の審判など）で死ぬ。

### 獣使いの永続性

魔獣は消耗品、獣使い（GitHubユーザー）は永続。名声と素材が蓄積する。

魔獣が死んでも獣使いには資産が残り、次の魔獣に継承できる。ローグライク的サイクル。

### 同階級ランダムマッチ

対戦相手は同階級からランダム。指名制は強者が弱者を狩る問題があるため採用しない。

指名対戦は将来拡張として残す。

### 入力自由・出力で世界観担保

入力時の表現制限（Lint）はしない。窮屈になる。

代わりにAIプロンプトで硬派・重厚なトーンを出力する。CIはスキーマとインジェクション検出のみ。

### 同時所持1体

獣使いが同時に持てる魔獣は1体。「この1体に賭ける」緊張感。

死んだら次を登録できる。将来的に名声に応じた複数体解禁の余地を残す。

### 素材は描写として継承

数値補正ではなく、物語として継承する。「父の顎骨が、その牙に宿っている」のように。

AIがバトル描写に織り込む。

### 定期興行1日1回

21:00 JSTに定期興行（GitHub Actions cron）。登録時は初陣で即フィードバック。

「今日の結果を見る」習慣を作る。

## ワークフロー

### 魔獣登録

```
1. ユーザーがIssue作成（フォーム入力）
2. GitHub Actionsがトリガー
3. フォーム内容からYAML生成
4. 空欄のフィールドをAIが自動生成（origin, lore, traits, skills）
5. PRを自動作成
6. CIでバリデーション（スキーマ、インジェクション検出）
7. 自動マージ → beasts/ に追加
8. 初陣バトル実行
```

### 定期興行

```
1. 毎日21:00 JSTにcron起動
2. beasts/ から対戦カードを生成（同階級ランダム）
3. GitHub Models（GPT-4o）でバトル描写生成
4. 勝敗・生死を決定
5. battle_logs/ に戦闘記録をコミット
6. 死亡した魔獣を graveyard/ へ移動
7. RANKING.md を更新
8. 獣使いデータ（binders/）を更新
```

### 死亡処理

```
1. AIが死亡を判定（戦闘中 or イベント）
2. beasts/{name}.yml を graveyard/{name}.md へ変換
3. 墓碑（死の物語、戦績）を記録
4. 素材を生成し、獣使いの資産に追加
5. 獣使いの active_beast を null に
```

## データ構造

### 魔獣（beasts/*.yml）

```yaml
# --- 必須（ユーザー入力） ---
name: 喰尾のグリム
species: 屍食い鬣犬
binder: username

# --- 任意（空ならAI生成） ---
origin: 東部戦線跡地にて捕獲

lore: |
  大飢饉の年、東部戦線に打ち捨てられた兵の屍が丘を成した。
  その丘に棲む鬣犬の群れは、やがて一匹を残して全て死に絶えた。
  生き残った一匹は仲間すらも喰らい、今なお飢えている。

traits:
  - 腐肉を喰らい続けた不死の飢え
  - 鈍重だが、顎の力は鉄をも噛み砕く
  - 死した群れの幻影がつきまとう

skills:
  - name: 死臭の息
    description: 腐敗の瘴気を吐く。浴びた者の傷口から壊死が広がる
  - name: 群れの記憶
    description: 死した群れの幻影が現れ、獲物を囲い込む

# --- システム管理 ---
status: alive
arena: local
wins: 0
losses: 0

# --- 肉（継承系、任意） ---
materials:
  - from: 別の魔獣名
    part: 顎骨
    description: 砕かれた顎骨の欠片。噛みつく力が宿る

bloodline:
  parent: 親魔獣名
  inherited_skill: 技名
```

### 獣使い（binders/*.yml）

```yaml
username: example
fame: 120
materials:
  - from: 喰尾のグリム
    part: 心臓
    description: まだ脈打つかのような、黒ずんだ心臓
active_beast: 現在の魔獣名
```

### 戦闘記録（battle_logs/*.md）

front matter付きMarkdown。

```markdown
---
date: 2024-12-30T21:00:00+09:00
arena: local
combatants:
  - name: 喰尾のグリム
    binder: user1
  - name: 静寂のイル
    binder: user2
victor: 静寂のイル
death: false
---

# 喰尾のグリム vs 静寂のイル

闘技場に二つの影が対峙した。

グリムは低く唸り、腐臭を纏った息を吐いた。
イルは微動だにしない。眼窩の闇が、グリムを見つめている。

先に動いたのはグリムだった。地を蹴り、腐臭の息を吐きながら突進する。
だがイルは動かない。囀りが一つ、響いた。

グリムの足が止まった。何かを、思い出そうとしている。
群れの記憶か。それとも、奪われた何かか。

その隙を、イルは逃さなかった。

## 観客の審判

観客席がざわめいた。

「見事だ」と誰かが叫んだ。親指が上を向く。

グリムは傷ついた体を引きずり、闘技場の門をくぐった。
今日は、生き延びた。
```

### 墓碑（graveyard/*.md）

```markdown
---
name: 喰尾のグリム
species: 屍食い鬣犬
binder: user1
wins: 7
losses: 3
arena: central
materials_left:
  - part: 心臓
    description: まだ脈打つかのような、黒ずんだ心臓
  - part: 顎骨
    description: 鉄をも噛み砕いた顎の骨
---

# 喰尾のグリム

第十戦、対「静寂のイル」。

観客は沈黙した。親指は下を向いていた。

灰の婆は、亡骸の前でただ一言呟いた。

「やっと満たされたか」
```

### ランキング（RANKING.md）

自動生成。

```markdown
# 闘技場番付

## 大闘技場

| 魔獣       | 獣使い | 戦績    |
| ---------- | ------ | ------- |
| 静寂のイル | user2  | 12勝0敗 |

## 中央闘技場

...

## 地方闘技場

...

---

## 獣使い名声録

| 獣使い | 名声 |
| ------ | ---- |
| user2  | 250  |
| user1  | 180  |

---

## 墓標

| 魔獣         | 獣使い | 戦績   | 死因       |
| ------------ | ------ | ------ | ---------- |
| 喰尾のグリム | user1  | 7勝3敗 | 観客の審判 |
```

## ディレクトリ構成

```
beasts/           # 現役魔獣（YAML）
graveyard/        # 死亡魔獣の墓碑（Markdown）
binders/          # 獣使いデータ（YAML）
battle_logs/      # 戦闘記録（Markdown）
# tales/          # ユーザー投稿物語（Markdown）※肉スコープ
RANKING.md        # ランキング（自動生成）
src/prompts/
  world.md        # 共通世界観（AI生成時に自動挿入）
  generate-beast.md
  battle.md
.github/
  ISSUE_TEMPLATE/
    beast-registration.yml  # 魔獣登録フォーム
    # tale.yml              # Tale投稿フォーム ※肉スコープ
  workflows/
    register.yml  # Issue→PR変換
    battle.yml    # 初陣バトル実行
    arena.yml     # 定期興行（21:00 JST）
```

## ルール

### 階級

- 地方: 0-2勝
- 中央: 3-5勝
- 大闘技場: 6勝〜

昇格はAIが物語として描写する。

### 名声

- 勝利: +10
- 階級昇格: +50
- 上位魔獣撃破: +30

### 死の条件

AIが判断。以下のいずれか：

- 戦闘中に致命傷を受けた
- 敗北後、観客の審判で処刑された
- その他の突発イベント

生存した敗者は傷を負った状態で次の戦いへ。傷は traits や lore に追記される。

## バリデーション

### スキーマチェック

- 必須フィールド: name, species, binder
- 任意フィールド: origin, lore, traits, skills（空ならAI生成）
- skills: 最大3つ
- traits: 最大5つ

### インジェクション検出

以下のパターンを検出してPRを却下：

- `[SYSTEM]`, `[INST]` などのプロンプト制御文字列
- 極端に長い文字列（lore: 2000字以上、trait: 200字以上）
- Base64エンコードされた文字列

## コールドスタート

初期NPC魔獣を3〜5体用意。世界観を示しつつ、対戦相手になる。

NPCの binder は `npc` とし、獣使いランキングには含めない。

## リスク対策

### プロンプトインジェクション

CIでパターン検出。各フィールドをサニタイズしてからプロンプトに渡す。

### AIの判定の偏り

プロンプトで「traits と skills を必ず参照し、両者を公平に扱うこと」を明示。

勝敗が偏りすぎた場合はプロンプトを調整。

### 無料枠超過

1日1回の定期興行に制限。バトル数が増えた場合は頻度を下げる。
