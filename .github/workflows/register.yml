name: 魔獣登録

on:
  issues:
    types: [opened]

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  register:
    runs-on: ubuntu-latest
    if: contains(github.event.issue.labels.*.name, 'beast-registration')
    steps:
      - uses: actions/checkout@v6

      - name: Notify processing started
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue comment ${{ github.event.issue.number }} --body "獣の名が書庫に刻まれた。審査が始まる。"

      - uses: actions/setup-node@v6
        with:
          node-version-file: ".nvmrc"
          cache: "npm"

      - run: npm ci

      - name: Parse issue form
        id: parse
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.issue.body;
            const lines = body.split('\n');
            const data = {};
            let currentField = null;

            for (const line of lines) {
              if (line.startsWith('### ')) {
                currentField = line.replace('### ', '').trim().toLowerCase();
                data[currentField] = '';
              } else if (currentField && line.trim()) {
                data[currentField] += (data[currentField] ? '\n' : '') + line.trim();
              }
            }

            core.setOutput('name', data['name'] || '');
            core.setOutput('species', data['species'] || '');
            core.setOutput('origin', data['origin'] || '');
            core.setOutput('lore', data['lore'] || '');
            core.setOutput('traits', data['traits'] || '');
            core.setOutput('skills', data['skills'] || '');

      - name: Generate beast YAML
        id: generate
        env:
          GITHUB_TOKEN: ${{ secrets.MODELS_TOKEN }}
          BEAST_NAME: ${{ steps.parse.outputs.name }}
          BEAST_SPECIES: ${{ steps.parse.outputs.species }}
          BEAST_ORIGIN: ${{ steps.parse.outputs.origin }}
          BEAST_LORE: ${{ steps.parse.outputs.lore }}
          BEAST_TRAITS: ${{ steps.parse.outputs.traits }}
          BEAST_SKILLS: ${{ steps.parse.outputs.skills }}
          BINDER: ${{ github.event.issue.user.login }}
        run: |
          npx tsx src/workflows/register-cli.ts

      - name: Create PR
        id: create-pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BEAST_NAME="${{ steps.parse.outputs.name }}"
          ISSUE_NUMBER="${{ github.event.issue.number }}"
          BRANCH="beast/issue-${ISSUE_NUMBER}"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git checkout -b "$BRANCH"
          git add beasts/
          git commit -m "feat: 新魔獣「${BEAST_NAME}」を登録"
          git push origin "$BRANCH"

          echo "branch=$BRANCH" >> $GITHUB_OUTPUT

          PR_URL=$(gh pr create \
            --title "新魔獣「${BEAST_NAME}」登録" \
            --body "Issue #${ISSUE_NUMBER} からの登録\n\n獣使い: @${{ github.event.issue.user.login }}" \
            --base main \
            --head "$BRANCH")
          echo "pr_url=$PR_URL" >> $GITHUB_OUTPUT

          # PR番号を抽出してYAMLに書き込む
          PR_NUMBER=$(echo "$PR_URL" | grep -oE '[0-9]+$')
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT

      - name: Add PR number to beast YAML
        run: |
          BEAST_NAME="${{ steps.parse.outputs.name }}"
          BEAST_FILE=$(find beasts -name "*.yml" -newer .git/index | head -1)
          if [ -n "$BEAST_FILE" ]; then
            echo "pr_number: ${{ steps.create-pr.outputs.pr_number }}" >> "$BEAST_FILE"
            git add "$BEAST_FILE"
            git commit --amend --no-edit
            git push origin "${{ steps.create-pr.outputs.branch }}" --force
          fi

      - name: Close issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue close ${{ github.event.issue.number }} --comment "審査を終えた。門が開かれるのを待て。 → ${{ steps.create-pr.outputs.pr_url }}"
